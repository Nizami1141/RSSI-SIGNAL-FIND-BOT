import time
import random
from collections import deque
from picarx import Picarx

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
px = Picarx()

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–ò–°–ö–ê ---
FINISH_THRESHOLD = -46     # –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª >= -46, —Å—Ç–æ–ø (–ø–æ–±–µ–¥–∞)
PRECISION_ZONE = -52       # –ó–æ–Ω–∞, –≥–¥–µ –∑–∞–º–µ–¥–ª—è–µ–º—Å—è (-52 –∏ –ª—É—á—à–µ)
RSSI_TOLERANCE = 1.5       # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–Ω—å—à–µ 1.5 dBm (—à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ)

# --- –ü–ê–†–ê–ú–ï–¢–†–´ –î–í–ò–ñ–ï–ù–ò–Ø ---
FAST_SPEED = 50
SLOW_SPEED = 25
TURN_ANGLE = 35

# --- –°–ò–°–¢–ï–ú–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
WINDOW_SIZE = 8            # –ß—É—Ç—å –º–µ–Ω—å—à–µ –æ–∫–Ω–æ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏
rssi_history = deque(maxlen=WINDOW_SIZE)
last_avg_rssi = None       # –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ RSSI

# –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞: 1 = –í–ø—Ä–∞–≤–æ, -1 = –í–ª–µ–≤–æ
# –†–æ–±–æ—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å, –∫—É–¥–∞ –æ–Ω –∫—Ä—É—Ç–∏–ª —Ä—É–ª—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑
search_direction = 1       

# --- –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ---
OBSTACLE_LIMIT = 20        # –°–º

# ================= –§–£–ù–ö–¶–ò–ò =================

def get_rssi_linux():
    try:
        with open("/proc/net/wireless", "r") as f:
            lines = f.readlines()
            for line in lines:
                if "wlan0" in line:
                    parts = line.split()
                    rssi = float(parts[3].replace('.', ''))
                    return rssi
    except Exception:
        return None

def stop_robot():
    px.forward(0)
    px.set_dir_servo_angle(0)

def smart_backup():
    """–£–º–Ω—ã–π –æ—Ç—ä–µ–∑–¥ –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è"""
    print("‚õî –ü–†–ï–ü–Ø–¢–°–¢–í–ò–ï -> –ú–ê–ù–ï–í–† –£–ö–õ–û–ù–ï–ù–ò–Ø")
    px.stop()
    time.sleep(0.2)
    
    # –û—Ç—ä–µ–∑–∂–∞–µ–º –Ω–∞–∑–∞–¥, –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—è –≤ –ü–†–û–¢–ò–í–û–ü–û–õ–û–ñ–ù–£–Æ —Å—Ç–æ—Ä–æ–Ω—É –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
    # –ï—Å–ª–∏ –∏—Å–∫–∞–ª–∏ –≤–ø—Ä–∞–≤–æ, –æ—Ç—ä–µ–∑–∂–∞–µ–º "–∑–∞–¥–æ–º –≤–ª–µ–≤–æ", —á—Ç–æ–±—ã –Ω–æ—Å –ø–æ–≤–µ—Ä–Ω—É–ª—Å—è –≤–ø—Ä–∞–≤–æ
    backup_angle = -35 if search_direction == 1 else 35
    px.set_dir_servo_angle(backup_angle)
    
    px.backward(40)
    time.sleep(1.2) # –û—Ç—ä–µ–∑–∂–∞–µ–º –ø–æ–¥–æ–ª—å—à–µ
    px.stop()
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å
    rssi_history.clear()
    global last_avg_rssi
    last_avg_rssi = None

# ================= –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ =================

print(f"--- Wi-Fi Seeker v3.0 (Adaptive) ---")
print(f"–¶–µ–ª—å: >= {FINISH_THRESHOLD} dBm")
stop_robot()
time.sleep(2)

try:
    while True:
        # 1. –ß–¢–ï–ù–ò–ï –î–ê–¢–ß–ò–ö–û–í
        dist = px.ultrasonic.read()
        raw_rssi = get_rssi_linux()

        # 2. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        if dist > 0 and dist < OBSTACLE_LIMIT:
            smart_backup()
            continue

        # 3. –û–ë–†–ê–ë–û–¢–ö–ê WI-FI
        if raw_rssi is not None:
            rssi_history.append(raw_rssi)
            
            # –ñ–¥–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞
            if len(rssi_history) < WINDOW_SIZE:
                print(f"Calibrating... {raw_rssi}")
                time.sleep(0.1)
                continue

            curr_rssi = sum(rssi_history) / len(rssi_history)

            # --- –ü–†–û–í–ï–†–ö–ê –§–ò–ù–ò–®–ê ---
            if curr_rssi >= FINISH_THRESHOLD:
                print("\n" + "="*40)
                print(f"üèÜ –§–ò–ù–ò–®! –°–∏–≥–Ω–∞–ª: {curr_rssi:.1f} dBm")
                print("="*40 + "\n")
                stop_robot()
                break

            # --- –í–´–ë–û–† –°–ö–û–†–û–°–¢–ò ---
            speed = SLOW_SPEED if curr_rssi >= PRECISION_ZONE else FAST_SPEED
            
            # --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ---
            if last_avg_rssi is None:
                # –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
                last_avg_rssi = curr_rssi
                px.set_dir_servo_angle(0)
                px.forward(speed)
                continue

            # –í—ã—á–∏—Å–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ (Delta)
            delta = curr_rssi - last_avg_rssi

            # –ê–ù–ê–õ–ò–ó –°–ò–¢–£–ê–¶–ò–ò
            if delta > RSSI_TOLERANCE:
                # --- –°–ò–¢–£–ê–¶–ò–Ø 1: –°–ò–ì–ù–ê–õ –†–ê–°–¢–ï–¢ (–¢–ï–ü–õ–ï–ï–¢) ---
                # –ú—ã –¥–≤–∏–∂–µ–º—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä—É–ª—å –∏ –µ–¥–µ–º –ø—Ä—è–º–æ.
                print(f"‚úÖ T+{delta:.1f} | {curr_rssi:.1f} dBm | –ü–†–Ø–ú–û")
                px.set_dir_servo_angle(0)
                px.forward(speed)

            elif delta < -RSSI_TOLERANCE:
                # --- –°–ò–¢–£–ê–¶–ò–Ø 2: –°–ò–ì–ù–ê–õ –ü–ê–î–ê–ï–¢ (–•–û–õ–û–î–ê–ï–¢) ---
                # –ú—ã –µ–¥–µ–º –Ω–µ —Ç—É–¥–∞. –ù—É–∂–Ω–æ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å.
                
                # –õ–æ–≥–∏–∫–∞ "–°–º–µ–Ω—ã —Ç–∞–∫—Ç–∏–∫–∏":
                # –ï—Å–ª–∏ –º—ã –µ—Ö–∞–ª–∏ –ø—Ä—è–º–æ (—É–≥–æ–ª 0) -> –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç (–≤ saved direction)
                # –ï—Å–ª–∏ –º—ã –£–ñ–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–ª–∏ -> –ó–Ω–∞—á–∏—Ç —ç—Ç–æ—Ç –ø–æ–≤–æ—Ä–æ—Ç –æ—à–∏–±–æ—á–Ω—ã–π! –ú–ï–ù–Ø–ï–ú –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï.
                
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —É–≥–æ–ª —Å–µ—Ä–≤–æ–ø—Ä–∏–≤–æ–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
                # (–í picarx –Ω–µ—Ç get_servo, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–≥–∏–∫—É)
                
                print(f"‚ùÑÔ∏è T{delta:.1f} | {curr_rssi:.1f} dBm | ", end="")

                # –ï—Å–ª–∏ –º—ã –¥—É–º–∞–ª–∏, —á—Ç–æ –µ–¥–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–µ—Ö–∞–ª–∏ –ø—Ä—è–º–æ), –Ω–æ —Å–∏–≥–Ω–∞–ª —É–ø–∞–ª
                # –ó–Ω–∞—á–∏—Ç, –≤–ø–µ—Ä–µ–¥–∏ —Å–∏–≥–Ω–∞–ª–∞ –Ω–µ—Ç. –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç.
                # –ù–æ –≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É? –í —Ç—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ search_direction
                
                # –ê –≤–æ—Ç –µ—Å–ª–∏ –º—ã –£–ñ–ï –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–≤–æ—Ä–æ—Ç–∞ –∏ —Å–∏–≥–Ω–∞–ª –ø–∞–¥–∞–µ—Ç,
                # –∑–Ω–∞—á–∏—Ç –º—ã –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ù–ï –¢–£–î–ê. –ú–µ–Ω—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É!
                
                # –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –ø–∞–¥–∞–µ—Ç –°–ò–õ–¨–ù–û (—Ö—É–∂–µ —á–µ–º -3 dB), –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                if delta < -3.0:
                     search_direction *= -1
                     print("–†–ê–ó–í–û–†–û–¢ –ü–û–ò–°–ö–ê (Bad drop) -> ", end="")
                
                # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç
                angle = TURN_ANGLE * search_direction
                print(f"–ü–û–ò–°–ö {'–í–ü–†–ê–í–û' if search_direction==1 else '–í–õ–ï–í–û'}")
                
                px.set_dir_servo_angle(angle)
                px.forward(speed)
                
                # –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –ø–∞–¥–∞–µ—Ç 2 —Ü–∏–∫–ª–∞ –ø–æ–¥—Ä—è–¥, –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ 
                # –º—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∏ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å search_direction.
                # –ü–æ–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Å–º–µ–Ω—É –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –ø–∞–¥–µ–Ω–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ —Ä–∞–∑.
                
                # –•–∞–∫ –¥–ª—è "–ø–∞–º—è—Ç–∏": –ï—Å–ª–∏ –º—ã –∫—Ä—É—Ç–∏–º –≤–ø—Ä–∞–≤–æ, –∏ —Å—Ç–∞–ª–æ —Ö—É–∂–µ,
                # –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ (—á–µ—Ä–µ–∑ delta) –ø–æ–ø—Ä–æ–±—É–µ–º –≤–ª–µ–≤–æ.
                # –ù–æ –º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —É—Å—Ç–æ–π—á–∏–≤–æ–µ –ø–∞–¥–µ–Ω–∏–µ
                if delta < -RSSI_TOLERANCE: 
                    # –ì–æ—Ç–æ–≤–∏–º —Å–º–µ–Ω—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∏ –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –ø–ª–æ—Ö–æ
                    search_direction *= -1 

            else:
                # --- –°–ò–¢–£–ê–¶–ò–Ø 3: –ò–ó–ú–ï–ù–ï–ù–ò–ô –ù–ï–¢ (–®–£–ú) ---
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–ª–∏
                print(f"waiting... ({delta:.1f}) | {curr_rssi:.1f}")
                px.forward(speed)

            last_avg_rssi = curr_rssi

        else:
            px.stop()
            print("Wifi Error")

        time.sleep(0.15) # –ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–ø—Ä–æ—Å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

except KeyboardInterrupt:
    stop_robot()
